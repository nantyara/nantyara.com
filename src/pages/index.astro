---
import Layout from '../layouts/Layout.astro';
import ScheduleCard from '../components/ScheduleCard.astro';
import { loadAllSchedules } from '../utils/schedules';

// YAMLãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ï¼ˆå…¨ã¦ã® schedules/*.yml ã‚’çµ±åˆï¼‰
const allSchedules = loadAllSchedules();

// 12æ™‚é–“ãƒ«ãƒ¼ãƒ«: ç¾åœ¨æ™‚åˆ» - 12æ™‚é–“ã‚’åŸºæº–ã«æŒ¯ã‚Šåˆ†ã‘
const expireTime = Date.now() - 12 * 60 * 60 * 1000;

// ä»Šå¾Œã®äºˆå®šï¼ˆæ˜‡é †ï¼šç›´è¿‘â†’æœªæ¥ï¼‰
const upcomingSchedules = allSchedules
  .filter(s => new Date(s.date).getTime() >= expireTime)
  .sort((a, b) => new Date(a.date).getTime() - new Date(b.date).getTime());

// éå»ã®äºˆå®šï¼ˆé™é †ï¼šæ–°ã—ã„â†’å¤ã„ï¼‰
const pastSchedules = allSchedules
  .filter(s => new Date(s.date).getTime() < expireTime)
  .sort((a, b) => new Date(b.date).getTime() - new Date(a.date).getTime());

// çµåˆï¼ˆä»Šå¾Œ â†’ éå»ã®é †ï¼‰
const schedules = [...upcomingSchedules, ...pastSchedules];
---

<Layout title="ãƒ©ã‚¤ãƒ–äºˆå®š | ãªã‚“ã¡ã‚ƒã‚‰ã‚¢ã‚¤ãƒ‰ãƒ«">
  <Fragment slot="head">
    <!-- Basic OGP -->
    <meta property="og:title" content="ãƒ©ã‚¤ãƒ–äºˆå®š | ãªã‚“ã¡ã‚ƒã‚‰ã‚¢ã‚¤ãƒ‰ãƒ«" />
    <meta property="og:description" content="ãªã‚“ã¡ã‚ƒã‚‰ã‚¢ã‚¤ãƒ‰ãƒ«å…¬å¼ã‚µã‚¤ãƒˆ" />
    <meta property="og:type" content="website" />
    <meta property="og:url" content="https://nantyara.com" />
    <meta property="og:site_name" content="ãªã‚“ã¡ã‚ƒã‚‰ã‚¢ã‚¤ãƒ‰ãƒ«" />
    <meta property="og:locale" content="ja_JP" />
    <meta property="og:image" content="https://nantyara.com/img/ogp-default.png" />
    <meta property="og:image:width" content="1200" />
    <meta property="og:image:height" content="630" />
    <meta property="og:image:alt" content="ãªã‚“ã¡ã‚ƒã‚‰ã‚¢ã‚¤ãƒ‰ãƒ«" />

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="ãƒ©ã‚¤ãƒ–äºˆå®š | ãªã‚“ã¡ã‚ƒã‚‰ã‚¢ã‚¤ãƒ‰ãƒ«" />
    <meta name="twitter:description" content="ãªã‚“ã¡ã‚ƒã‚‰ã‚¢ã‚¤ãƒ‰ãƒ«å…¬å¼ã‚µã‚¤ãƒˆ" />
    <meta name="twitter:image" content="https://nantyara.com/img/ogp-default.png" />
    <meta name="twitter:image:alt" content="ãªã‚“ã¡ã‚ƒã‚‰ã‚¢ã‚¤ãƒ‰ãƒ«" />
  </Fragment>

  <div class="schedule-controls">
    <div class="filter-buttons">
      <button class="filter-btn active" data-filter="upcoming">
        ğŸ“… ä»Šå¾Œã®äºˆå®š
      </button>
      <button class="filter-btn" data-filter="past">
        ğŸ“œ éå»ã®äºˆå®š
      </button>
      <button class="filter-btn" data-filter="all">
        ğŸ“‹ ã™ã¹ã¦
      </button>
    </div>

    <div class="search-box">
      <input
        type="text"
        id="search-input"
        placeholder="ğŸ” ã‚¤ãƒ™ãƒ³ãƒˆåã‚„ä¼šå ´ã‚’æ¤œç´¢..."
        class="search-input"
      />
    </div>
  </div>

  <div id="schedule-list" class="schedule-list">
    {schedules.length === 0 ? (
      <div class="empty-state">
        <div class="title">äºˆå®šã¯ã‚ã‚Šã¾ã›ã‚“</div>
        <p>ç¾åœ¨ã€äºˆå®šã•ã‚Œã¦ã„ã‚‹ã‚¤ãƒ™ãƒ³ãƒˆã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
      </div>
    ) : (
      schedules.map(schedule => (
        <div
          class="schedule-item"
          data-date={new Date(schedule.date).getTime()}
          data-title={schedule.title.toLowerCase()}
          data-site={schedule.site.toLowerCase()}
        >
          <ScheduleCard
            date={new Date(schedule.date)}
            title={schedule.title}
            site={schedule.site}
            content={schedule.content}
            images={schedule.images}
            slug={schedule.slug}
          />
        </div>
      ))
    )}
  </div>

  <div id="no-results" class="empty-state" style="display: none;">
    <div class="title">è©²å½“ã™ã‚‹ã‚¤ãƒ™ãƒ³ãƒˆãŒã‚ã‚Šã¾ã›ã‚“</div>
    <p>æ¤œç´¢æ¡ä»¶ã‚’å¤‰æ›´ã—ã¦ãã ã•ã„ã€‚</p>
  </div>

  <!-- ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="schedule-modal" class="modal">
    <div class="modal-overlay"></div>
    <div class="modal-content">
      <button class="modal-close" aria-label="é–‰ã˜ã‚‹">âœ•</button>
      <div class="modal-body">
        <h2 id="modal-title" class="modal-title"></h2>
        <div id="modal-images" class="modal-images"></div>
      </div>
    </div>
  </div>
</Layout>

<script is:inline define:vars={{ schedules }}>
  document.addEventListener('DOMContentLoaded', () => {
    const filterButtons = document.querySelectorAll('.filter-btn');
    const searchInput = document.getElementById('search-input');
    const scheduleList = document.getElementById('schedule-list');
    const scheduleItems = document.querySelectorAll('.schedule-item');
    const noResults = document.getElementById('no-results');
    const modal = document.getElementById('schedule-modal');
    const modalClose = document.querySelector('.modal-close');
    const modalOverlay = document.querySelector('.modal-overlay');
    const modalTitle = document.getElementById('modal-title');
    const modalImages = document.getElementById('modal-images');

    let currentFilter = 'upcoming';

    // 12æ™‚é–“ãƒ«ãƒ¼ãƒ«: ç¾åœ¨æ™‚åˆ» - 12æ™‚é–“ã‚’åŸºæº–ã«æŒ¯ã‚Šåˆ†ã‘
    const expireTime = Date.now() - 12 * 60 * 60 * 1000;

    const filterSchedules = () => {
      const searchTerm = searchInput ? searchInput.value.toLowerCase() : '';
      let visibleCount = 0;

      scheduleItems.forEach(item => {
        const date = parseInt(item.dataset.date || '0');
        const title = item.dataset.title || '';
        const site = item.dataset.site || '';

        // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æ¡ä»¶
        let matchesFilter = false;
        if (currentFilter === 'upcoming') {
          matchesFilter = date >= expireTime;
        } else if (currentFilter === 'past') {
          matchesFilter = date < expireTime;
        } else {
          matchesFilter = true; // all
        }

        // æ¤œç´¢æ¡ä»¶
        const matchesSearch = !searchTerm ||
          title.includes(searchTerm) ||
          site.includes(searchTerm);

        if (matchesFilter && matchesSearch) {
          item.style.display = 'block';
          visibleCount++;
        } else {
          item.style.display = 'none';
        }
      });

      // çµæœãŒãªã„å ´åˆ
      if (scheduleList) scheduleList.style.display = visibleCount > 0 ? 'flex' : 'none';
      if (noResults) noResults.style.display = visibleCount === 0 ? 'block' : 'none';
    };

    // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
    filterButtons.forEach(button => {
      button.addEventListener('click', () => {
        filterButtons.forEach(btn => btn.classList.remove('active'));
        button.classList.add('active');
        currentFilter = button.dataset.filter || 'all';
        filterSchedules();
      });
    });

    // æ¤œç´¢å…¥åŠ›ã‚¤ãƒ™ãƒ³ãƒˆ
    if (searchInput) {
      searchInput.addEventListener('input', filterSchedules);
    }

    // ãƒ¢ãƒ¼ãƒ€ãƒ«é–¢é€£
    const openModal = (title) => {
      const schedule = schedules.find(s => s.title === title);
      if (!schedule || !schedule.images || schedule.images.length === 0) return;

      modalTitle.textContent = title;
      modalImages.innerHTML = '';

      schedule.images.forEach((imagePath) => {
        const img = document.createElement('img');
        img.src = imagePath;
        img.alt = title + ' ã®ç”»åƒ';
        img.className = 'modal-image';
        img.loading = 'lazy';
        modalImages.appendChild(img);
      });

      modal.classList.add('open');
      document.body.style.overflow = 'hidden';
    };

    const closeModal = () => {
      modal.classList.remove('open');
      document.body.style.overflow = '';
    };

    // è©³ç´°ãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
    document.querySelectorAll('.view-details-btn').forEach(function(btn) {
      btn.addEventListener('click', function() {
        const title = btn.getAttribute('data-schedule-title');
        if (title) openModal(title);
      });
    });

    // ãƒ¢ãƒ¼ãƒ€ãƒ«é–‰ã˜ã‚‹ã‚¤ãƒ™ãƒ³ãƒˆ
    if (modalClose) {
      modalClose.addEventListener('click', closeModal);
    }
    if (modalOverlay) {
      modalOverlay.addEventListener('click', closeModal);
    }

    // Escapeã‚­ãƒ¼ã§é–‰ã˜ã‚‹
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape' && modal.classList.contains('open')) {
        closeModal();
      }
    });

    // åˆæœŸè¡¨ç¤º
    filterSchedules();
  });
</script>

<style>
  .schedule-controls {
    max-width: 1280px;
    margin: 0 auto 30px;
    padding: 0 20px;
  }

  .filter-buttons {
    display: flex;
    justify-content: center;
    gap: 12px;
    flex-wrap: wrap;
    margin-bottom: 20px;
  }

  .filter-btn {
    padding: 12px 24px;
    background: linear-gradient(135deg, var(--retro-purple) 0%, var(--retro-pink) 100%);
    color: white;
    border: 2px solid rgba(255, 255, 255, 0.2);
    border-radius: 25px;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow:
      0 4px 0 rgba(0, 0, 0, 0.3),
      0 0 15px rgba(255, 110, 199, 0.4);
  }

  .filter-btn:hover {
    transform: translateY(-2px);
    box-shadow:
      0 6px 0 rgba(0, 0, 0, 0.3),
      0 0 25px rgba(255, 110, 199, 0.6);
  }

  .filter-btn.active {
    background: linear-gradient(135deg, var(--retro-cyan) 0%, var(--retro-purple) 100%);
    box-shadow:
      0 4px 0 rgba(0, 0, 0, 0.3),
      0 0 25px rgba(0, 255, 255, 0.6);
  }

  .search-box {
    max-width: 600px;
    margin: 0 auto;
  }

  .search-input {
    width: 100%;
    padding: 14px 20px;
    font-size: 1rem;
    background: rgba(26, 26, 46, 0.8);
    border: 2px solid var(--retro-pink);
    border-radius: 30px;
    color: var(--text-light);
    outline: none;
    transition: all 0.3s ease;
    box-shadow:
      0 0 15px rgba(255, 110, 199, 0.3),
      inset 0 0 10px rgba(0, 0, 0, 0.3);
  }

  .search-input::placeholder {
    color: var(--pastel-pink);
  }

  .search-input:focus {
    border-color: var(--retro-cyan);
    box-shadow:
      0 0 25px rgba(0, 255, 255, 0.5),
      inset 0 0 10px rgba(0, 0, 0, 0.3);
  }

  .schedule-list {
    display: flex;
    justify-content: center;
    align-items: stretch;
    flex-wrap: wrap;
    gap: 20px;
    margin: 30px auto;
    padding: 0 20px;
    width: 100%;
    max-width: 100%;
  }

  .schedule-item {
    flex: 0 0 auto;
  }

  /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ */
  @media (max-width: 768px) {
    .schedule-item {
      width: 100%;
    }

    .filter-btn {
      font-size: 0.9rem;
      padding: 10px 20px;
    }

    .search-input {
      font-size: 0.95rem;
      padding: 12px 18px;
    }
  }

  @media (max-width: 480px) {
    .schedule-controls {
      padding: 0 10px;
    }

    .filter-buttons {
      gap: 8px;
    }

    .filter-btn {
      font-size: 0.85rem;
      padding: 10px 16px;
    }

    .search-input {
      font-size: 0.9rem;
      padding: 12px 16px;
    }
  }

  /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
  .modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 2000;
    display: none;
  }

  .modal.open {
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .modal-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.9);
    z-index: 2001;
  }

  .modal-content {
    position: relative;
    max-width: 900px;
    max-height: 90vh;
    width: 90%;
    background: linear-gradient(180deg, var(--bg-dark) 0%, var(--bg-medium) 100%);
    border: 3px solid var(--retro-pink);
    border-radius: 20px;
    box-shadow:
      0 8px 0 rgba(0, 0, 0, 0.5),
      0 0 40px rgba(255, 110, 199, 0.6),
      0 0 80px rgba(0, 255, 255, 0.3);
    z-index: 2002;
    overflow: hidden;
    animation: modal-appear 0.3s ease;
  }

  @keyframes modal-appear {
    from {
      opacity: 0;
      transform: scale(0.9) translateY(20px);
    }
    to {
      opacity: 1;
      transform: scale(1) translateY(0);
    }
  }

  .modal-close {
    position: absolute;
    top: 20px;
    right: 20px;
    width: 48px;
    height: 48px;
    background: rgba(255, 255, 255, 0.2);
    border: 2px solid white;
    border-radius: 50%;
    color: white;
    font-size: 1.5rem;
    cursor: pointer;
    z-index: 2003;
    transition: all 0.3s ease;
  }

  .modal-close:hover {
    background: rgba(255, 255, 255, 0.3);
    transform: rotate(90deg);
  }

  .modal-body {
    padding: 60px 30px 30px;
    max-height: 90vh;
    overflow-y: auto;
  }

  .modal-title {
    font-size: 2rem;
    font-weight: 900;
    color: var(--text-light);
    text-shadow:
      2px 2px 0 var(--retro-pink),
      4px 4px 0 var(--retro-cyan);
    margin: 0 0 30px 0;
    text-align: center;
  }

  .modal-images {
    display: flex;
    flex-direction: column;
    gap: 20px;
  }

  .modal-image {
    width: 100%;
    height: auto;
    border-radius: 12px;
    border: 3px solid var(--retro-cyan);
    box-shadow:
      0 4px 0 rgba(0, 0, 0, 0.3),
      0 0 20px rgba(0, 255, 255, 0.4);
    transition: all 0.3s ease;
    cursor: pointer;
  }

  .modal-image:hover {
    transform: scale(1.02);
    box-shadow:
      0 6px 0 rgba(0, 0, 0, 0.3),
      0 0 30px rgba(0, 255, 255, 0.6);
  }

  /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ */
  @media (max-width: 768px) {
    .modal-content {
      width: 95%;
      max-height: 95vh;
    }

    .modal-body {
      padding: 50px 20px 20px;
    }

    .modal-title {
      font-size: 1.5rem;
      margin-bottom: 20px;
    }

    .modal-close {
      width: 44px;
      height: 44px;
      top: 15px;
      right: 15px;
    }
  }

  @media (max-width: 480px) {
    .modal-content {
      width: 100%;
      max-height: 100vh;
      border-radius: 0;
    }

    .modal-body {
      padding: 50px 15px 15px;
    }

    .modal-title {
      font-size: 1.3rem;
      text-shadow:
        2px 2px 0 var(--retro-pink),
        3px 3px 0 var(--retro-cyan);
    }

    .modal-images {
      gap: 15px;
    }
  }

  /* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ç„¡åŠ¹åŒ–ï¼ˆã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£ï¼‰ */
  @media (prefers-reduced-motion: reduce) {
    .filter-btn,
    .search-input {
      transition: none !important;
    }

    .filter-btn:hover {
      transform: none;
    }

    .modal-content {
      animation: none !important;
    }

    .modal-image:hover,
    .modal-close:hover {
      transform: none;
    }
  }
</style>
